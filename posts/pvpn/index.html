<!doctype html><html><head><meta charset=utf-8><title>Making ProtonVPN Usable on Linux - M. Rincón</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=preload href=https://mrincon.net/fonts/Mona-Sans.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet type=text/css media=screen href=https://mrincon.net/css/light.css><link rel=stylesheet type=text/css media=screen href=https://mrincon.net/css/syntax.css></head><body><div class="container wrapper post"><div class=header><base href=https://mrincon.net/><div class=site-description><h1 class=site-title><a href=https://mrincon.net/>M. Rincón
</a>&mdash;
<small>Guided by the asterik</small></h1><ul class=flat><li><a href><object alt=rss data=svg/rss.svg type=image/svg+xml></object></a></li><li><a href><object alt=github data=svg/github.svg type=image/svg+xml></object></a></li><li><a href><object alt=mastodon data=svg/mastodon.svg type=image/svg+xml></object></a></li></ul></div><nav class=nav><ul class=flat><li><a href=/>About</a></li><li><a href=posts/>Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>Making ProtonVPN Usable on Linux</h1><div class=meta>2023-02-21
<span class=modified-label>Revised: 2024-03-02</span></div></div><div class=markdown><p>ProtonVPN provides a GUI and a console application for Linux, but on 2023, it is nearly
unusable. It consumes up to 2 GB of memory idled, drops connections, and fails to
reconnect unless the kill switch is deleted using <code>nmcli</code>. The command line application has
a <a href=https://github.com/ProtonVPN/linux-cli/issues/62>bizarre dependency</a> on <code>nm-applet</code>, which of course means it cannot be used on a headless
machine. It <a href=https://github.com/ProtonVPN/linux-app/issues/49>appears</a> that <code>ProtonVPN</code> is not going to fix this. The solution is to use
<code>ProtonVPN</code> with <code>Wireguard</code>.</p><p>First, install <code>Wireguard</code> and <code>ufw</code>. Then, log into <code>ProtonVPN</code>, and in the download section,
get a few <code>Wireguard</code> configuration files. Add them to the <code>NetworkManager</code>. By default, all
new <code>wireguard</code> connections will auto connect on start up. Since I only want one default
connection, I modified all but one. In addition, I disabled <code>IPv6</code> on all the connection.</p><div class="src src-sh"><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>nmcli con import <span class=nb>type</span> wireguard file &lt;connection.conf&gt;
</span></span><span class=line><span class=cl>nmcli con modify &lt;connection&gt; ipv6.method <span class=s2>&#34;ignore&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># if not the default connection:</span>
</span></span><span class=line><span class=cl>nmcli con mod &lt;connection&gt; connection.autoconnect no
</span></span><span class=line><span class=cl>nmcli con down &lt;connection&gt;
</span></span><span class=line><span class=cl>nmcli -f name,autoconnect connection</span></span></code></pre></div></div><p>I also wanted a <code>killswitch</code>, so I used <code>ufw</code> to configure one (Fedora comes with <code>FirewallD</code>,
but I'm familiar with <code>ufw</code>). First I disabled connections outside my <code>LAN</code>. Because I want to
be able to reconnect without turning off the firewall, I made exceptions for the <code>VPN</code>
connections by allowing paths to the end points in the configuration files.</p><div class="src src-sh"><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ignore the 127.0.0.1/8 range, that&#39;s the loop back</span>
</span></span><span class=line><span class=cl>ip address <span class=p>|</span> grep inet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ufw reset
</span></span><span class=line><span class=cl>ufw default deny outgoing
</span></span><span class=line><span class=cl>ufw default deny incoming
</span></span><span class=line><span class=cl><span class=c1># whitelist the range found with ip address</span>
</span></span><span class=line><span class=cl>ufw allow in to &lt;range start/end&gt;
</span></span><span class=line><span class=cl>ufw allow out to&lt;range start/end&gt;
</span></span><span class=line><span class=cl>ufw allow out to &lt;ip&gt; port &lt;port number&gt; proto udp
</span></span><span class=line><span class=cl>ufw allow out on &lt;connection&gt; from any to any
</span></span><span class=line><span class=cl>ufw enable</span></span></code></pre></div></div><p>At this point there shouldn't be any connection outside the <code>LAN</code> unless I have a <code>VPN</code>
connections.</p><div class="src src-sh"><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ping google should fail</span>
</span></span><span class=line><span class=cl>ping 8.8.8.8
</span></span><span class=line><span class=cl><span class=c1># but work after vpn is activate</span>
</span></span><span class=line><span class=cl>nmcli --ask con up &lt;vpn name&gt;
</span></span><span class=line><span class=cl>ping google
</span></span><span class=line><span class=cl><span class=c1># we can also check for leaks</span>
</span></span><span class=line><span class=cl>curl https://ipleak.net/json/ <span class=p>|</span> jq
</span></span><span class=line><span class=cl><span class=c1># and in the DNS</span>
</span></span><span class=line><span class=cl><span class=nv>session</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> mrfox <span class=p>|</span> sha1sum<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>5000</span> 5003<span class=k>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>   curl <span class=s2>&#34;https://</span><span class=si>${</span><span class=nv>session</span><span class=p>:</span><span class=nv>0</span><span class=p>:</span><span class=nv>40</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nv>i</span><span class=si>}</span><span class=s2>.ipleak.net/dnsdetection/&#34;</span>
</span></span><span class=line><span class=cl>   sleep <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div></div><p>If all works as expected, <code>ufw</code> can be set as a service.</p><div class="src src-sh"><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># If active, disable firewalld</span>
</span></span><span class=line><span class=cl>systemctl disable --now firewalld.service
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now ufw.service
</span></span><span class=line><span class=cl>ufw status
</span></span><span class=line><span class=cl><span class=c1># To see what was blocked</span>
</span></span><span class=line><span class=cl>journalctl -t kernel -fag <span class=s2>&#34;UFW BLOCK&#34;</span></span></span></code></pre></div></div></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/linux>linux</a></li></ul></nav></div></div><div class="footer wrapper"><nav class=nav><div>All content by M. Rincón
is licensed under
<a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY 4.0</a></div></nav></div></body></html>