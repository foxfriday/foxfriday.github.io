<!doctype html><html><head><meta charset=utf-8><title>Eat Evil - M. Rincón</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=preload href=https://mrincon.net/fonts/Mona-Sans.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet type=text/css media=screen href=https://mrincon.net/css/light.css><link rel=stylesheet type=text/css media=screen href=https://mrincon.net/css/syntax.css></head><body><div class="container wrapper post"><div class=header><base href=https://mrincon.net/><div class=site-description><h1 class=site-title><a href=https://mrincon.net/>M. Rincón
</a>&mdash;
<small>Guided by asteriks</small></h1><ul class=flat><li><a href><object alt=rss data=svg/rss.svg type=image/svg+xml></object></a></li><li><a href><object alt=github data=svg/github.svg type=image/svg+xml></object></a></li><li><a href><object alt=mastodon data=svg/mastodon.svg type=image/svg+xml></object></a></li></ul></div><nav class=nav><ul class=flat><li><a href=/>About</a></li><li><a href=posts/>Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>Eat Evil</h1><div class=meta>2024-03-27</div></div><div class=markdown><p><a href=https://codeberg.org/akib/emacs-eat>Eat</a> is a terminal emulator for Emacs available in <code>NonGNU ELpa</code>. Eat is much slower than
foot, but faster than <code>term.el</code>. It has some nice features like <code>sixel</code> support, and being
able to send messages to Emacs. It also has some surprising idiosyncrasies which makes
adding Evil key bindings and other modifications challenging.</p><p>I think that the default state, semi char mode, captures too many key combinations. This
can be changed by modifying <code>eat-semi-char-non-bound-keys</code> and reloading eat. But doing that
inside a <code>whith-eval-after-load</code> block creates an infinite loop. To prevent the loop, the
reloading should be done inside a <code>let</code> block:</p><div class="src src-emacs-lisp"><div class=highlight><pre tabindex=0 class=chroma><code class=language-emacs-lisp data-lang=emacs-lisp><span class=line><span class=cl><span class=p>(</span><span class=nb>with-eval-after-load</span> <span class=ss>&#39;eat</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>setq</span> <span class=nv>eat-semi-char-non-bound-keys</span> <span class=p>(</span><span class=nf>list</span> <span class=p>[</span><span class=sc>?\C</span><span class=nv>-\\</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                                           <span class=p>[</span><span class=sc>?\C</span><span class=nv>-w</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                                           <span class=p>[</span><span class=sc>?\C</span><span class=nv>-h</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                                           <span class=p>[</span><span class=sc>?\C</span><span class=nv>-x</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                                           <span class=p>[</span><span class=sc>?\e</span> <span class=sc>?x</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>eat-update-semi-char-mode-map</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>after-load-alist</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nv>after-load-functions</span> <span class=no>nil</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>eat-reload</span><span class=p>)))</span></span></span></code></pre></div></div><p>Though eat doesn't work well with Evil, eat is a modal terminal emulator. And these modes
can be leveraged to make it a bit more evil. This requires starting eat with a new
function, <code>my-eat-start</code>:</p><div class="src src-emacs-lisp"><div class=highlight><pre tabindex=0 class=chroma><code class=language-emacs-lisp data-lang=emacs-lisp><span class=line><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>my-eat-end</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Kill and close the eat buffer.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>eat-kill-process</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>kill-this-buffer</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>my-eat-emacs-mode</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Help create a normal state with `eat-emacs-mode`.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>eat-emacs-mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>evil-define-key*</span> <span class=ss>&#39;normal</span> <span class=nv>eat-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;[[&#34;</span><span class=p>)</span> <span class=ss>&#39;eat-previous-shell-prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>evil-define-key*</span> <span class=ss>&#39;normal</span> <span class=nv>eat-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;]]&#34;</span><span class=p>)</span> <span class=ss>&#39;eat-next-shell-prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>evil-define-key*</span> <span class=ss>&#39;normal</span> <span class=nv>eat-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;i&#34;</span><span class=p>)</span> <span class=ss>&#39;my-eat-semi-char-mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>evil-define-key*</span> <span class=ss>&#39;normal</span> <span class=nv>eat-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;gO&#34;</span><span class=p>)</span> <span class=ss>&#39;browse-url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>evil-define-key*</span> <span class=ss>&#39;normal</span> <span class=nv>eat-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;q&#34;</span><span class=p>)</span> <span class=ss>&#39;my-eat-end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>evil-normal-state</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>my-eat-semi-char-mode</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Create bindings for `eat-mode` and switch to Emacs state.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>eat-semi-char-mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w h&#34;</span> <span class=ss>&#39;evil-window-left</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w l&#34;</span> <span class=ss>&#39;evil-window-right</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w k&#34;</span> <span class=ss>&#39;evil-window-up</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w j&#34;</span> <span class=ss>&#39;evil-window-down</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w +&#34;</span> <span class=ss>&#39;evil-window-increase-height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w -&#34;</span> <span class=ss>&#39;evil-window-decrease-height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w &lt;&#34;</span> <span class=ss>&#39;evil-window-decrease-width</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w &gt;&#34;</span> <span class=ss>&#39;evil-window-increase-width</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w =&#34;</span> <span class=ss>&#39;balance-windows</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w R&#34;</span> <span class=ss>&#39;evil-window-rotate-upwards</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w r&#34;</span> <span class=ss>&#39;evil-window-rotate-downwards</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w W&#34;</span> <span class=ss>&#39;evil-window-prev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w w&#34;</span> <span class=ss>&#39;evil-window-next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w s&#34;</span> <span class=ss>&#39;evil-window-split</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w v&#34;</span> <span class=ss>&#39;evil-window-vsplit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w _&#34;</span> <span class=ss>&#39;evil-window-set-height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w |&#34;</span> <span class=ss>&#39;evil-window-set-width</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w c&#34;</span> <span class=ss>&#39;evil-window-delete</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w n&#34;</span> <span class=ss>&#39;evil-window-new</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w o&#34;</span> <span class=ss>&#39;delete-other-windows</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w p&#34;</span> <span class=ss>&#39;evil-window-mru</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w q&#34;</span> <span class=ss>&#39;evil-quit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w N&#34;</span> <span class=ss>&#39;my-eat-emacs-mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-\\ C-n&#34;</span> <span class=ss>&#39;my-eat-emacs-mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-\\ C-p&#34;</span> <span class=ss>&#39;eat-send-password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-w \&#34;&#34;</span> <span class=ss>&#39;eat-yank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-x b&#34;</span> <span class=ss>&#39;switch-to-buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-x k&#34;</span> <span class=ss>&#39;my-eat-end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>keymap-set</span> <span class=nv>eat-mode-map</span> <span class=s>&#34;C-x p&#34;</span> <span class=ss>&#39;eat-send-password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>evil-emacs-state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nf>goto-char</span> <span class=p>(</span><span class=nf>point-max</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>my-eat-start</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Start Eat in the current project root directory in another window.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>require</span> <span class=ss>&#39;project</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>require</span> <span class=ss>&#39;eat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>let*</span> <span class=p>((</span><span class=nv>proj</span> <span class=p>(</span><span class=nv>project-current</span> <span class=no>nil</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>if</span> <span class=nv>proj</span> <span class=p>(</span><span class=nb>let*</span> <span class=p>((</span><span class=nv>default-directory</span> <span class=p>(</span><span class=nv>project-root</span> <span class=nv>proj</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=nv>eat-buffer-name</span> <span class=p>(</span><span class=nv>project-prefixed-buffer-name</span> <span class=s>&#34;eat&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>               <span class=p>(</span><span class=nv>eat-other-window</span><span class=p>)</span>
</span></span><span class=line><span class=cl>               <span class=p>(</span><span class=nv>switch-to-buffer</span> <span class=nv>eat-buffer-name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>               <span class=p>(</span><span class=nv>my-eat-semi-char-mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nb>progn</span> <span class=p>(</span><span class=nv>eat-other-window</span><span class=p>)</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span><span class=nv>switch-to-buffer</span> <span class=nv>eat-buffer-name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span><span class=nv>my-eat-semi-char-mode</span><span class=p>)))))</span></span></span></code></pre></div></div><p>Eat also provides great color support; however, if <code>.bashrc</code> is making some color settings
based on the terminal name, the file needs to be modified.</p><div class="src src-sh"><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1>### Color support</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>TERM</span><span class=si>}</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>    xterm-color<span class=p>|</span>*-256color<span class=p>|</span>foot<span class=p>|</span>*-truecolor<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> Making color settings...
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    ,*<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> :<span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$EAT_SHELL_INTEGRATION_DIR</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -r <span class=s2>&#34;</span><span class=nv>$EAT_SHELL_INTEGRATION_DIR</span><span class=s2>/bash&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=c1># shellcheck source=/dev/null</span>
</span></span><span class=line><span class=cl>        <span class=nb>source</span> <span class=s2>&#34;</span><span class=nv>$EAT_SHELL_INTEGRATION_DIR</span><span class=s2>/bash&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></div></div><p>One nice thing about eat is that it can communicate with Emacs. With a few modifications,
eat can open a file inside the host Emacs. With this change the command <code>_eat_msg open</code> will open
a file in Emacs.</p><div class="src src-emacs-lisp"><div class=highlight><pre tabindex=0 class=chroma><code class=language-emacs-lisp data-lang=emacs-lisp><span class=line><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>my-eat-open</span> <span class=p>(</span><span class=nv>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Helper function to open files from eat terminal.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nf>file-exists-p</span> <span class=nv>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nv>find-file-other-window</span> <span class=nv>file</span> <span class=no>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=ne>warn</span> <span class=s>&#34;File doesn&#39;t exist&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nv>add-to-list</span> <span class=ss>&#39;eat-message-handler-alist</span> <span class=p>(</span><span class=nf>cons</span> <span class=s>&#34;open&#34;</span> <span class=ss>&#39;my-eat-open</span><span class=p>))</span></span></span></code></pre></div></div><p>And for ease of use, the command can be aliased toe <code>emopen</code> in <code>.bashrc</code>.</p><div class="src src-sh"><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>emopen</span><span class=o>=</span><span class=s1>&#39;_eat_msg open&#39;</span></span></span></code></pre></div></div></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/emacs>emacs</a></li></ul></nav></div></div><div class="footer wrapper"><nav class=nav><div>All content by M. Rincón
is licensed under
<a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY 4.0</a></div></nav></div></body></html>